
const line2 = [
	{
		crdnt_x: "126.975411",
		route: "2호선",
		crdnt_y: "37.563588",
		statn_nm: "시청",
		statn_id: "0201",
	},
	{
		crdnt_x: "126.982618",
		route: "2호선",
		crdnt_y: "37.566014",
		statn_nm: "을지로입구",
		statn_id: "0202",
	},
	{
		crdnt_x: "126.991696",
		route: "2호선",
		crdnt_y: "37.566306",
		statn_nm: "을지로3가",
		statn_id: "0203",
	},
	{
		crdnt_x: "126.997817",
		route: "2호선",
		crdnt_y: "37.566595",
		statn_nm: "을지로4가",
		statn_id: "0204",
	},
	{
		crdnt_x: "127.009054",
		route: "2호선",
		crdnt_y: "37.565613",
		statn_nm: "동대문역사문화공원",
		statn_id: "0205",
	},
	{
		crdnt_x: "127.019614",
		route: "2호선",
		crdnt_y: "37.56564",
		statn_nm: "신당",
		statn_id: "0206",
	},
	{
		crdnt_x: "127.029354",
		route: "2호선",
		crdnt_y: "37.564354",
		statn_nm: "상왕십리",
		statn_id: "0207",
	},
	{
		crdnt_x: "127.036954",
		route: "2호선",
		crdnt_y: "37.561238",
		statn_nm: "왕십리(성동구청)",
		statn_id: "0208",
	},
	{
		crdnt_x: "127.043655",
		route: "2호선",
		crdnt_y: "37.555273",
		statn_nm: "한양대",
		statn_id: "0209",
	},
	{
		crdnt_x: "127.047367",
		route: "2호선",
		crdnt_y: "37.547184",
		statn_nm: "뚝섬",
		statn_id: "0210",
	},
	{
		crdnt_x: "127.055961",
		route: "2호선",
		crdnt_y: "37.544581",
		statn_nm: "성수",
		statn_id: "0211",
	},
	{
		crdnt_x: "127.069191",
		route: "2호선",
		crdnt_y: "37.540373",
		statn_nm: "건대입구",
		statn_id: "0212",
	},
	{
		crdnt_x: "127.085916",
		route: "2호선",
		crdnt_y: "37.537077",
		statn_nm: "구의(광진구청)",
		statn_id: "0213",
	},
	{
		crdnt_x: "127.094681",
		route: "2호선",
		crdnt_y: "37.535095",
		statn_nm: "강변(동서울터미널)",
		statn_id: "0214",
	},
	{
		crdnt_x: "127.10379",
		route: "2호선",
		crdnt_y: "37.520733",
		statn_nm: "잠실나루",
		statn_id: "0215",
	},
	{
		crdnt_x: "127.100159",
		route: "2호선",
		crdnt_y: "37.513262",
		statn_nm: "잠실(송파구청)",
		statn_id: "0216",
	},
	{
		crdnt_x: "127.086162",
		route: "2호선",
		crdnt_y: "37.511687",
		statn_nm: "잠실새내",
		statn_id: "0217",
	},
	{
		crdnt_x: "127.073704",
		route: "2호선",
		crdnt_y: "37.511022",
		statn_nm: "종합운동장",
		statn_id: "0218",
	},
	{
		crdnt_x: "127.06316",
		route: "2호선",
		crdnt_y: "37.508844",
		statn_nm: "삼성(무역센터)",
		statn_id: "0219",
	},
	{
		crdnt_x: "127.048203",
		route: "2호선",
		crdnt_y: "37.504286",
		statn_nm: "선릉",
		statn_id: "0220",
	},
	{
		crdnt_x: "127.036456",
		route: "2호선",
		crdnt_y: "37.500622",
		statn_nm: "역삼",
		statn_id: "0221",
	},
	{
		crdnt_x: "127.027912",
		route: "2호선",
		crdnt_y: "37.49799",
		statn_nm: "강남",
		statn_id: "0222",
	},
	{
		crdnt_x: "127.014667",
		route: "2호선",
		crdnt_y: "37.493961",
		statn_nm: "교대(법원.검찰청)",
		statn_id: "0223",
	},
	{
		crdnt_x: "127.007917",
		route: "2호선",
		crdnt_y: "37.491897",
		statn_nm: "서초",
		statn_id: "0224",
	},
	{
		crdnt_x: "126.997596",
		route: "2호선",
		crdnt_y: "37.481426",
		statn_nm: "방배",
		statn_id: "0225",
	},
	{
		crdnt_x: "126.981544",
		route: "2호선",
		crdnt_y: "37.476538",
		statn_nm: "사당",
		statn_id: "0226",
	},
	{
		crdnt_x: "126.963693",
		route: "2호선",
		crdnt_y: "37.47693",
		statn_nm: "낙성대",
		statn_id: "0227",
	},
	{
		crdnt_x: "126.952739",
		route: "2호선",
		crdnt_y: "37.481247",
		statn_nm: "서울대입구(관악구청)",
		statn_id: "0228",
	},
	{
		crdnt_x: "126.941892",
		route: "2호선",
		crdnt_y: "37.482362",
		statn_nm: "봉천",
		statn_id: "0229",
	},
	{
		crdnt_x: "126.929715",
		route: "2호선",
		crdnt_y: "37.484201",
		statn_nm: "신림",
		statn_id: "0230",
	},
	{
		crdnt_x: "126.913149",
		route: "2호선",
		crdnt_y: "37.487462",
		statn_nm: "신대방",
		statn_id: "0231",
	},
	{
		crdnt_x: "126.901401",
		route: "2호선",
		crdnt_y: "37.485266",
		statn_nm: "구로디지털단지",
		statn_id: "0232",
	},
	{
		crdnt_x: "126.894932",
		route: "2호선",
		crdnt_y: "37.493243",
		statn_nm: "대림(구로구청)",
		statn_id: "0233",
	},
	{
		crdnt_x: "126.891084",
		route: "2호선",
		crdnt_y: "37.508961",
		statn_nm: "신도림",
		statn_id: "0234",
	},
	{
		crdnt_x: "126.89476",
		route: "2호선",
		crdnt_y: "37.517933",
		statn_nm: "문래",
		statn_id: "0235",
	},
	{
		crdnt_x: "126.89661",
		route: "2호선",
		crdnt_y: "37.525706",
		statn_nm: "영등포구청",
		statn_id: "0236",
	},
	{
		crdnt_x: "126.902767",
		route: "2호선",
		crdnt_y: "37.534946",
		statn_nm: "당산",
		statn_id: "0237",
	},
	{
		crdnt_x: "126.913808",
		route: "2호선",
		crdnt_y: "37.549457",
		statn_nm: "합정",
		statn_id: "0238",
	},
	{
		crdnt_x: "126.923708",
		route: "2호선",
		crdnt_y: "37.55679",
		statn_nm: "홍대입구",
		statn_id: "0239",
	},
	{
		crdnt_x: "126.936926",
		route: "2호선",
		crdnt_y: "37.555131",
		statn_nm: "신촌",
		statn_id: "0240",
	},
	{
		crdnt_x: "126.946013",
		route: "2호선",
		crdnt_y: "37.556733",
		statn_nm: "이대",
		statn_id: "0241",
	},
	{
		crdnt_x: "126.956141",
		route: "2호선",
		crdnt_y: "37.557345",
		statn_nm: "아현",
		statn_id: "0242",
	},
	{
		crdnt_x: "126.964378",
		route: "2호선",
		crdnt_y: "37.559704",
		statn_nm: "충정로(경기대입구)",
		statn_id: "0243",
	},
	{
		crdnt_x: "127.050899",
		route: "2호선",
		crdnt_y: "37.561904",
		statn_nm: "용답",
		statn_id: "0244",
	},
	{
		crdnt_x: "127.046481",
		route: "2호선",
		crdnt_y: "37.57004",
		statn_nm: "신답",
		statn_id: "0245",
	},
	{
		crdnt_x: "127.024932",
		route: "2호선",
		crdnt_y: "37.574747",
		statn_nm: "신설동",
		statn_id: "0246",
	},
	{
		crdnt_x: "126.882768",
		route: "2호선",
		crdnt_y: "37.514287",
		statn_nm: "도림천",
		statn_id: "0247",
	},
	{
		crdnt_x: "126.865819",
		route: "2호선",
		crdnt_y: "37.512398",
		statn_nm: "양천구청",
		statn_id: "0248",
	},
	{
		crdnt_x: "126.852912",
		route: "2호선",
		crdnt_y: "37.520074",
		statn_nm: "신정네거리",
		statn_id: "0249",
	},
	{
		crdnt_x: "127.038091",
		route: "2호선",
		crdnt_y: "37.574028",
		statn_nm: "용두(동대문구청)",
		statn_id: "0250",
	},
];
const arrivalDataArr = [];

const urlParams = new URLSearchParams(window.location.search);
const greetingValue = urlParams.get('statn_nm');

const prev_statn_nm = line2.findIndex(station => station.statn_nm === greetingValue)

console.log(prev_statn_nm)
const result4 = greetingValue.slice(0, greetingValue.indexOf("(") === -1 ? greetingValue.length : greetingValue.indexOf("("));

const slice = (str) => str.slice(0, str.indexOf("(") === -1 ? str.length : str.indexOf("("));

$('.station-current').text(result4)
$('.station-prev').text(slice(line2[prev_statn_nm - 1].statn_nm))

$('.station-next').text(slice(line2[prev_statn_nm + 1].statn_nm))

const fakeData = [
	{
		"beginRow": null,
		"endRow": null,
		"curPage": null,
		"pageRow": null,
		"totalCount": 7,
		"rowNum": 2,
		"selectedCount": 7,
		"subwayId": "1002",
		"subwayNm": null,
		"updnLine": "외선",
		"trainLineNm": "성수행 - 역삼방면",
		"subwayHeading": "오른쪽",
		"statnFid": "1002000223",
		"statnTid": "1002000221",
		"statnId": "1002000222",
		"statnNm": "강남",
		"trainCo": null,
		"ordkey": "01001성수0",
		"subwayList": "1002,1077",
		"statnList": "1002000222,1077000687",
		"btrainSttus": null,
		"barvlDt": "115",
		"btrainNo": "2179",
		"bstatnId": "88",
		"bstatnNm": "성수",
		"recptnDt": "2023-03-09 11:22:10",
		"arvlMsg2": "전역 도착",
		"arvlMsg3": "교대",
		"arvlCd": "5",
		"congestion": [
			"41",
			"72",
			"32",
			"32",
			"50",
			"79",
			"79",
			"35",
			"20",
			"35"
		]
	},
	{
		"beginRow": null,
		"endRow": null,
		"curPage": null,
		"pageRow": null,
		"totalCount": 7,
		"rowNum": 3,
		"selectedCount": 7,
		"subwayId": "1002",
		"subwayNm": null,
		"updnLine": "외선",
		"trainLineNm": "성수행 - 역삼방면",
		"subwayHeading": "오른쪽",
		"statnFid": "1002000223",
		"statnTid": "1002000221",
		"statnId": "1002000222",
		"statnNm": "강남",
		"trainCo": null,
		"ordkey": "02002성수0",
		"subwayList": "1002,1077",
		"statnList": "1002000222,1077000687",
		"btrainSttus": null,
		"barvlDt": "241",
		"btrainNo": "2181",
		"bstatnId": "88",
		"bstatnNm": "성수",
		"recptnDt": "2023-03-09 11:22:10",
		"arvlMsg2": "4분 1초 후",
		"arvlMsg3": "서초",
		"arvlCd": "99",
		"congestion": [
			"33",
			"33",
			"36",
			"36",
			"33",
			"33",
			"90",
			"105",
			"52",
			"50"
		]
	},
	{
		"beginRow": null,
		"endRow": null,
		"curPage": null,
		"pageRow": null,
		"totalCount": 7,
		"rowNum": 6,
		"selectedCount": 7,
		"subwayId": "1002",
		"subwayNm": null,
		"updnLine": "내선",
		"trainLineNm": "성수행 - 교대방면",
		"subwayHeading": "왼쪽",
		"statnFid": "1002000221",
		"statnTid": "1002000223",
		"statnId": "1002000222",
		"statnNm": "강남",
		"trainCo": null,
		"ordkey": "11002성수0",
		"subwayList": "1002,1077",
		"statnList": "1002000222,1077000687",
		"btrainSttus": null,
		"barvlDt": "140",
		"btrainNo": "2194",
		"bstatnId": "88",
		"bstatnNm": "성수",
		"recptnDt": "2023-03-09 11:22:10",
		"arvlMsg2": "2분 20초 후",
		"arvlMsg3": "선릉",
		"arvlCd": "99",
		"congestion": [
			"39",
			"24",
			"46",
			"50",
			"50",
			"37",
			"45",
			"105",
			"33",
			"24"
		]
	},
	{
		"beginRow": null,
		"endRow": null,
		"curPage": null,
		"pageRow": null,
		"totalCount": 7,
		"rowNum": 7,
		"selectedCount": 7,
		"subwayId": "1002",
		"subwayNm": null,
		"updnLine": "내선",
		"trainLineNm": "성수행 - 교대방면",
		"subwayHeading": "왼쪽",
		"statnFid": "1002000221",
		"statnTid": "1002000223",
		"statnId": "1002000222",
		"statnNm": "강남",
		"trainCo": null,
		"ordkey": "12007성수0",
		"subwayList": "1002,1077",
		"statnList": "1002000222,1077000687",
		"btrainSttus": null,
		"barvlDt": "663",
		"btrainNo": "2196",
		"bstatnId": "88",
		"bstatnNm": "성수",
		"recptnDt": "2023-03-09 11:22:10",
		"arvlMsg2": "11분 3초 후",
		"arvlMsg3": "잠실",
		"arvlCd": "99",
		"congestion": [
			"29",
			"46",
			"71",
			"29",
			"50",
			"87",
			"77",
			"38",
			"49",
			"56"
		]
	}
]

$("#getArrivalData").on("click", function () {
	showLoader()
	getArrivalData();
	/* 	insertData(fakeData)
	 */
});




getArrivalData()
showLoader()
async function getArrivalData() {
	if (arrivalDataArr.length) {
		arrivalDataArr.splice(0, arrivalDataArr.length);
	}
	try {

		const response = await fetch(
			`http://swopenapi.seoul.go.kr/api/subway/46774250416c65653835766c785069/json/realtimeStationArrival/0/20/${result4}`,
			{ method: "GET" }
		);

		const { realtimeArrivalList } = await response.json();

		realtimeArrivalList.forEach((el) => {

			if (el.btrainNo.slice(0, 1) !== "6" && el.subwayId === "1002") {
				el.btrainNo = "2" + el.btrainNo.slice(1);
				arrivalDataArr.push(el);
			}
		});

		console.log(realtimeArrivalList)

		getCongestionData();


	} catch (err) {
		console.log(err);
	}
}

async function getCongestionData() {
	try {
		const options = {
			method: "GET",
			headers: {
				accept: "application/json",
				appkey: "WxRVdcwpU92Vv6qQh9s6c5moBazIJt0L5ckJxWFV",
				"x-cors-api-key": "temp_b6d5d3fa1419d3723d7e07b36d611fad",
				origin: `https://apis.openapi.sk.com/`,
			},
		};

		const requests = arrivalDataArr.map((data) =>
			fetch(
				`https://proxy.cors.sh/https://apis.openapi.sk.com/puzzle/congestion-train/rltm/trains/2/${data.btrainNo}`,
				/* 		`https://proxy.cors.sh/https://apis.openapi.sk.com/puzzle/congestion-train/rltm/trains/2/${data.btrainNo}`, */
				/* `https://cors-anywhere.herokuapp.com/https://apis.openapi.sk.com/puzzle/congestion-train/rltm/trains/2/${data.btrainNo}`, */
				options
			)
		);

		const responses = await Promise.allSettled(requests);
		console.log(responses)
		const congestionData = await Promise.allSettled(


			responses.map((res) =>
				(res.status === 'fulfilled') ?
					res.value.json() : ''
			)
		);

		console.log(congestionData)

		congestionData.forEach(({ value: { data } }) => {
			if (!data) {
				return;
			}

			const itemOfArrivalDataArr = arrivalDataArr.find(
				(el) => el.btrainNo === data.trainY
			);

			itemOfArrivalDataArr.congestion =
				data.congestionResult.congestionCar.split("|");
		});

		console.log(arrivalDataArr)

		insertData(arrivalDataArr);
	} catch (err) {
		console.log(err);
	}
}

function showLoader() {

	$(".train").css('visibility', 'hidden');
	$(".container").append('<div class="loader-box"> <img src="img/train2.png" class="loader"> <div class="track"> </div> </div>')

}

function insertData(arrivalDataArr) {
	$(".train").css('visibility', 'visible');

	$('.loader-box').remove()

	console.log(arrivalDataArr)

	function getLevel(number) {
		let level = 4;

		if (number < 0) {
			level = 0;
		}
		else if (number < 30) {
			level = 1;
		} else if (number < 50) {
			level = 2;
		} else if (number < 60) {
			level = 3;
		}

		return level;
	}



	[arrivalDataArr.filter(i => i.updnLine === "내선"), arrivalDataArr.filter(i => i.updnLine !== "내선")].forEach(line => {

		console.log(line)

		line[0].congestion = line[0].congestion || [-1, -1, -1, -1, -1, -1, -1, -1, -1, -1]
		const congestionHtml = line[0].congestion.map(
			(number) =>
				` <span data-crowded='${getLevel(number)}'>
					${getLevel(number)}
					</span>`
		)

		const trainHtml = `
		<i class="fa-solid fa-location-dot"></i>
		
		${line[0].updnLine === "내선"
				? `
				
				<div  class='train-msg'>
				
				${line[0].arvlMsg3}  · 
				${line[0].arvlMsg2} ${line[0].arvlMsg2.slice(-2) !== " 후" ? "" : "도착"} </div>
						<span class='train-number'> <i class="fa-solid fa-train"></i> <span> ${line[0].btrainNo
				} </span> </span> `
				: `
					<div  class='train-msg'> ${line[0].arvlMsg3}  ·  ${line[0].arvlMsg2} ${line[0].arvlMsg2.slice(-2) !== " 후" ? "" : "도착"
				} 
				
				  </div>
				  <span class='train-number'>  <span> ${line[0].btrainNo
				} </span><i class="fa-solid fa-train"></i> </span>  
				 
				  `
			}
		<div class='congestion'>  ${congestionHtml.join("")}
		
	   </div>

	   <div class='next-train'>  ${line[1] ? '다음 열차 ·' + line[1].arvlMsg2 : '&nbsp; '}</div>
	   
	`;

		if (line[0].updnLine === "내선") {


			$(".inline-train").html(trainHtml);


		} else {


			$(".outline-train").html(trainHtml);


		}
	})


}

(function ($) {
	$("#nav").load("nav.html .nav-box");
})(jQuery);


